<!DOCTYPE html>
<html>
<head>
    <title>Chat Application</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Chat Room</h1>
            <button onclick="openCloud()">Cloud</button>
        </div>
        <div id="chat" class="chat-messages"></div>
        <div class="chat-input">
            <input id="message" type="text" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div class="cloud-container" id="cloud-container" style="display:none;">
        <div class="cloud-header">
            <h1>Cloud Storage</h1>
            <button onclick="closeCloud()">Back to Chat</button>
        </div>
        <div id="file-list" class="file-list"></div>
        <div class="file-upload">
            <input id="file-input" type="file">
            <button onclick="uploadFile()">Upload File</button>
        </div>
    </div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('message', (data) => {
            const chat = document.getElementById('chat');
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            if (data.username === username) {
                messageElement.classList.add('my-message');
            } else {
                messageElement.classList.add('other-message');
            }
            messageElement.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        });

        let username = '';

        document.addEventListener('DOMContentLoaded', () => {
            username = localStorage.getItem('username');
            if (!username) {
                window.location.href = '/login.html';
                return;
            }

            // 세션 ID 쿠키에 저장
            fetch('/get-session-id')
                .then(response => response.json())
                .then(data => {
                    document.cookie = `sessionId=${data.sessionId}; path=/`;
                });

            socket.emit('message', { username: username, message: 'has joined the chat' });
        });

        function openCloud() {
            document.querySelector('.chat-container').style.display = 'none';
            document.querySelector('.cloud-container').style.display = 'flex';
            loadFiles();
        }

        function closeCloud() {
            document.querySelector('.cloud-container').style.display = 'none';
            document.querySelector('.chat-container').style.display = 'flex';
        }

        function loadFiles() {
            fetch('/files')
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('file-list');
                    fileList.innerHTML = '';
                    data.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.classList.add('file-item');
                        fileElement.innerHTML = `<a href="${file.url}" target="_blank">${file.name}</a>`;
                        fileList.appendChild(fileElement);
                    });
                });
        }

        function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert('File uploaded successfully');
                loadFiles();
            });
        }

        function sendMessage() {
            const message = document.getElementById('message').value;
            socket.emit('message', { username: username, message: message });
            document.getElementById('message').value = '';
        }
    </script>
</body>
</html>
